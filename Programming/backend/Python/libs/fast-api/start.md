
- –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è –Ω–∞–ø–∏—Å–Ω–∏—è –∫–æ–¥–∞ –Ω–∞ fastapi  - https://github.com/zhanymkanov/fastapi-best-practices
- Awesome FastAPI - https://github.com/mjhea0/awesome-fastapi
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—è –≤ FastAPI - https://habr.com/ru/articles/714570/
- https://fastapi.tiangolo.com/advanced/custom-response/#html-response
- https://github.com/faststream-community/fastapi-dishka-faststream

```python
print(json.dumps(data, ensure_ascii=False, indent=2))
```

–ø–∞–∫–µ—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
pip install pytest

–ø–∞–∫–µ—Ç –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
pip install black

–ø—Ä–∏–º–µ–Ω—è–µ–º—ã–µ –≤–µ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- FastAPI ‚Äî —Å–∞–º –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫, (pip install fastapi);
- Uvicorn ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤–µ–±-—Å–µ—Ä–≤–µ—Ä, (pip install uvicorn);
- HTTPie ‚Äî —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–µ–±-–∫–ª–∏–µ–Ω—Ç, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ curl, (pip install httpie);
- Requests ‚Äî –ø–∞–∫–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤–µ–±-–∫–ª–∏–µ–Ω—Ç–∞, (pip install requests);
- HTTPX ‚Äî –ø–∞–∫–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ/–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤–µ–±-–∫–ª–∏–µ–Ω—Ç–∞, (pip install httpx).
- Starlette - –ø–∞–∫–µ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- Pydantic - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞  –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é –ø–æ–¥—Å–∫–∞–∑–æ–∫ —Ç–∏–ø–æ–≤
- mypy - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ç–∏–ø–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å –æ—à–∏–±–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º —Ç–∏–ø–æ–≤, –µ—â—ë –¥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã (pip install mypy).
- sqlalchemy - –æ—Ä–º –¥–ª—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö (pip install sqlalchemy)


**Web Server Gateway Interface (WSGI)** (https://wsgi.readthedocs.io) ‚Äî —ç—Ç–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (https://peps.python.org/pep-3333) Python –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞–º. –í—Å–µ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ Python –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ WSGI. –ù–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å, —á—Ç–æ –≤—ã –∑–∞–Ω—è—Ç—ã –æ–∂–∏–¥–∞–Ω–∏–µ–º —á–µ–≥–æ-—Ç–æ, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≥–æ—Ä–∞–∑–¥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –¥–∏—Å–∫–∞–º –∏–ª–∏ —Å–µ—Ç–∏. –¢–æ–≥–¥–∞ –≤—ã –±—É–¥–µ—Ç–µ –∏—Å–∫–∞—Ç—å –ª—É—á—à—É—é –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å. –í –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–¥—ã –æ–Ω–∞ –ø—Ä–∏–æ–±—Ä–µ—Ç–∞–µ—Ç –≤—Å–µ –±–æ–ª—å—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –±—ã–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è **Asynchronous Server Gateway Interface (ASGI)** (https://asgi.readthedocs.io) –¥–ª—è Python. 

üîπ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å FastAPI
```bash
pip install "fastapi[standard]"
```

üîπ –ó–∞–ø—É—Å–∫ FastAPI
```bash
# –±—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
$ fastapi dev main.py

# –ó–∞–ø—É—Å–∫–∞—è Uvicorn –Ω–∞–ø—Ä—è–º—É—é
# –°–ª–æ–≤–æ hello –¥–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª hello.py, –∞ —Å–ª–æ–≤–æ app ‚Äî —ç—Ç–æ –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
$ uvicorn hello:app --reload

# –ó–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—Ç–µ
# –≤ –≥–ª–∞–≤–Ω–æ–º (main.py) —Ñ–∞–π–ª–µ –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ–º
if __name__ == '__main__':
	uvicorn.run('main.app')

# –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
$ python main.py

# –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ñ–æ–Ω–µ
$ python main.py &
```

```bash
# —É–≤–∏–¥–µ—Ç—å –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä uvicorn
$ ps aux | grep uvicorn

# –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤—Ä–µ, —Ç–æ —É–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å, –±–µ—Ä–µ–º PID –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–æ–º–∞–Ω–¥—ã –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É

$ kill -9 <PID>
```

üîπ –ü–æ –ø—É—Ç–∏ http://127.0.0.1:8000/docs –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) api-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (OpenAPI)

---

##### –¢–∏–ø—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏

* –ü—Ä–∏ ==–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö== –≤—ã—á–∏—Å–ª–µ–Ω–∏—è—Ö –∑–∞–¥–∞—á–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –º–µ–∂–¥—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º–∏ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞–º–∏ (–¶–ü). –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤, —Ç–∞–∫–∏—Ö –∫–∞–∫ –∑–∞–¥–∞—á–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ.
* –ü—Ä–∏ ==–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö== –≤—ã—á–∏—Å–ª–µ–Ω–∏—è—Ö –∫–∞–∂–¥—ã–π –¶–ü –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞—á–∏ –∏–∑ –ø–æ—Ç–æ–∫–∞ –∑–∞–Ω–∏–º–∞—é—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –æ–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –°—á–∏—Ç—ã–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–ª–∏ –¥–æ—Å—Ç—É–ø–∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É —Å–µ—Ç–µ–≤–æ–º—É —Å–µ—Ä–≤–∏—Å—É –±—É–∫–≤–∞–ª—å–Ω–æ –≤ —Ç—ã—Å—è—á–∏ –∏ –º–∏–ª–ª–∏–æ–Ω—ã —Ä–∞–∑ –º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –≤ –¶–ü


–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å
FastAPI —Å–∞–º –≤—ã–∑—ã–≤–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç GET-–∑–∞–ø—Ä–æ—Å. –í–∞–º –Ω–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ await –∫—É–¥–∞-–ª–∏–±–æ.–ù–æ –¥–ª—è –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π —Ñ—É–Ω–∫—Ü–∏–π async def –≤—ã–∑—ã–≤–∞—é—â–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–º–µ—Å—Ç–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä await –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –≤—ã–∑–æ–≤–æ–º

---

–ë–î –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏

`aiosqlite`¬†‚Äî —ç—Ç–æ¬†==–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö¬†SQLite¬†–≤ —è–∑—ã–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è Python==. –û–Ω–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite –≤ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–º —Ä–µ–∂–∏–º–µ, —á—Ç–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞, —Ç–∞–∫–æ–≥–æ –∫–∞–∫ –±–æ—Ç—ã –∏–ª–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫

```bash
pip install aiosqlite
```

---
#### üîπ START PROJECT
```bash
mkdir app/src && cd app

python3 -m venv venv && source venv/bin/activate

pip install "fastapi[standard]"
pip install python-dotenv
pip install pydantic-settings
pip install SQLAlchemy

touch {.env,.env.dist,.gitignore}

cd src && touch {main,__init__,config,database}.py

mkdir requirements \
	&& cd requirements \
	&& touch {base,dev,test,prod}.txt \
	&& cd ../

mkdir user && cd user && touch {router,schemas,models,dependencies,config,constans,exceptions,service,utils}.py
```

üî∏ **src/main.py**
```python
from fastapi import FastAPI  
import uvicorn  
  
app = FastAPI()  
  
@app.get("/")  
async def root():  
    return {  
        "app": "API",  
        "env": 'local',  
        "version": 1.0  
    }  
  
if __name__ == "__main__":  
    uvicorn.run("main:app", reload=True)
```

üî∏ **–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä**
```bash
 python3 src/main.py
```
---
#### üîπ –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–¥

##### üî∏ Postgres

—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–∫–∏–µ –ø–∞–∫–µ—Ç—ã
- **psycopg2-binary** ‚Äî –¥—Ä–∞–π–≤–µ—Ä –¥–ª—è PostgreSQL
- **Alembic** ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
```bash
pip install sqlalchemy psycopg2-binary alembic
```

- –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∫–æ–Ω—Ñ–∏–≥–æ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
```python
from pydantic_settings import BaseSettings, SettingsConfigDict  
  
class DatabaseConfig(BaseSettings):  
    model_config = SettingsConfigDict(  
        env_file=".env",  
        env_prefix="DB_", 
        extra="ignore"  
    )  
     # –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é  
    host: str = "localhost"  
    port: int = 5432  
    username: str  
    password: str  
    database: str  
  
    def url(self) -> str:  
        return f"postgresql+psycopg2://{self.username}:{self.password}@{self.host}:{self.port}/{self.database}"  
  
class Config(BaseSettings):  
    db: DatabaseConfig = DatabaseConfig()
```

- –≤ .env –¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
```env
DB_HOST=localhost  
DB_DATABASE=db  
DB_PORT=5432  
DB_USERNAME=root  
DB_PASSWORD=password
```

- —Å–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª -`database.py` (–≥–¥–µ –±—É–¥–µ—Ç —Å–µ—Å—Å–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–¥)
```python
from typing import Annotated, Generator  
from sqlalchemy import create_engine  
from sqlalchemy.orm import DeclarativeBase, sessionmaker, Session  
from fastapi import Depends  
  
from src.config import Config  
  
config = Config()  
  
# –ù–µ —Å–æ–∑–¥–∞—ë–º engine –∑–¥–µ—Å—å, —ç—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∏–∂–µ  
engine = None  
SessionLocal = None  
  
class Base(DeclarativeBase):  
    pass  
  
def init_db(db_url: str = None):  
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ URL"""  
    global engine, SessionLocal  
  
    if db_url is None:  
        db_url = config.db.url  
  
    engine = create_engine(  
        db_url,  
        echo=False, # –≤—ã–≤–æ–¥ –ª–æ–≥–æ–≤ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª  
        pool_pre_ping=True,  
        pool_size=10,  
        max_overflow=20  
    )  
  
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)  
  
    return engine, SessionLocal  
  
def get_db():  
    """–ü–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é –ë–î"""  
    if SessionLocal is None:  
        init_db()  
  
    db = SessionLocal()  
    try:  
        yield db  
    finally:  
        db.close()  
  
async def dispose() -> None:  
    """–ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î"""  
    global engine  
    if engine is not None:  
        await engine.dispose()  
        engine = None  
  
DbSessionDep = Annotated[Session, Depends(get_db)]
```

-  –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Alembic –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Alembic (`alembic/env.py`), –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ Alembic –∑–¥–µ—Å—å - [[alembic]]

- –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª–∏ 
```python
from sqlalchemy import Column, Integer, String, DateTime  
from datetime import datetime  
from src.database import Base  
  
class User(Base):  
    __tablename__ = "users"  
    id = Column(Integer, primary_key=True, index=True)  
    name = Column(String(255), nullable=False)  
    email = Column(String(255), unique=True, nullable=False)  
    created_at = Column(DateTime, default=datetime.utcnow)
```

- –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
alembic revision --autogenerate -m "Initial migration"
```

- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
alembic upgrade head
```
---
#### üîπ Async db session

```bash
pip install asyncpg
pip install greenlet
# or
poetry add asyncpg
poetry add greenlet
```

==–í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ Async SQLAlchemy==
1. **Lazy Loading**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è SQLAlchemy **–ó–ê–ü–†–ï–©–ê–ï–¢** –ª–µ–Ω–∏–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å–≤—è–∑–µ–π. –ï—Å–ª–∏ –≤—ã –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ `user.role.permissions` –≤ –∫–æ–¥–µ, –ø–æ–ª—É—á–∏—Ç–µ –æ—à–∏–±–∫—É.
    - **–†–µ—à–µ–Ω–∏–µ**: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–ª–∏ `selectinload` –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö. `joinedload`
2. **–ó–∞–ø—Ä–æ—Å—ã**:
    - ‚Üí `await session.scalar(stmt)` `session.scalar(stmt)`
    - `session.scalars(stmt).all()` ‚Üí `result = await session.execute(stmt); result.scalars().all()`
3. **–¢–µ—Å—Ç—ã**: –í–∞—à–∏ —Ç–µ—Å—Ç—ã —Ç–æ–∂–µ –ø—Ä–∏–¥–µ—Ç—Å—è –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å –Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É—è `pytest-asyncio` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏.
4. **–ú–∏–≥—Ä–∞—Ü–∏–∏**: –í –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Ç–∞–∫–∂–µ —Å–º–µ–Ω–∏—Ç—å URL, –ª–∏–±–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Alembic –Ω–∞ —Ä–∞–±–æ—Ç—É —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –¥–≤–∏–∂–∫–æ–º (–æ–±—ã—á–Ω–æ —á–µ—Ä–µ–∑ `run_async` –≤ ). `alembic.ini``env.py`

==–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ==
```python
# app/database.py
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy.orm import DeclarativeBase

# –í–∞–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ—Ñ–∏–∫—Å sqlite+aiosqlite –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã
SQLALCHEMY_DATABASE_URL = "sqlite+aiosqlite:///./sql_app.db"

# 1. –°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ (Async Engine)
engine = create_async_engine(
    SQLALCHEMY_DATABASE_URL, 
    connect_args={"check_same_thread": False} # –ù—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è SQLite
)

# 2. –°–æ–∑–¥–∞–µ–º —Ñ–∞–±—Ä–∏–∫—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π.
# expire_on_commit=False ‚Äî –≤–∞–∂–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è async, —á—Ç–æ–±—ã –æ–±—ä–µ–∫—Ç—ã –Ω–µ "–ø—Ä–æ—Ç—É—Ö–∞–ª–∏" –ø–æ—Å–ª–µ –∫–æ–º–∏—Ç–∞.
AsyncSessionLocal = async_sessionmaker(
    bind=engine, 
    class_=AsyncSession, 
    expire_on_commit=False
)

# 3. –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –º–æ–¥–µ–ª–µ–π (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å SQLAlchemy 2.0)
class Base(DeclarativeBase):
    pass

# 4. Dependency (–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å).
# –≠—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä.
async def get_db():
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º async with ‚Äî —ç—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–µ—Å—Å–∏—è –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    async with AsyncSessionLocal() as db:
        yield db
```

##### üî∏ –í–Ω–µ–¥—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –≤ —Ä–æ—É—Ç–µ—Ä

==–ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä==
```python
# app/routers/users.py
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from app.database import get_db # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
from app import models, schemas

router = APIRouter(prefix="/users", tags=["Users"])

@router.post("/", response_model=schemas.UserResponse)
async def create_user(
    user: schemas.UserCreate, 
    # FastAPI —Å–∞–º –≤—ã–∑–æ–≤–µ—Ç get_db, –¥–æ–∂–¥–µ—Ç—Å—è —Å–µ—Å—Å–∏–∏ –∏ –ø–µ—Ä–µ–¥–∞—Å—Ç –µ—ë —Å—é–¥–∞
    db: AsyncSession = Depends(get_db) 
):
    # –•–µ—à–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Bcrypt!)
    fake_hashed_password = f"secret_hash_{user.password}" 

    db_user = models.User(email=user.email, hashed_password=fake_hashed_password)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–µ—Å—Å–∏—é (–∑–¥–µ—Å—å await –Ω–µ –Ω—É–∂–µ–Ω, —ç—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –≤ –ø–∞–º—è—Ç–∏)
    db.add(db_user)
    
    # –ê –≤–æ—Ç –∑–¥–µ—Å—å –º—ã "–æ—Ç–ø—É—Å–∫–∞–µ–º" —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –ø–æ–∫–∞ –±–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ.
    # –í —ç—Ç–æ –≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!
    await db.commit()
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–∞–∑—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—É—á–∞–µ–º –ø—Ä–∏—Å–≤–æ–µ–Ω–Ω—ã–π ID)
    await db.refresh(db_user)
    
    return db_user
```

- **–ù–∞—Å—Ç–æ—è—â–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å.**¬†–ò—Å–ø–æ–ª—å–∑—É—è¬†`async/await`¬†–∏¬†`AsyncSession`, –≤–∞—à —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç—ã—Å—è—á–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –ü–æ–∫–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∂–¥–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –¥–∏—Å–∫–∞ (–±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö), –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞. –ù–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ —Å–µ—Ä–≤–µ—Ä –±—ã –ø—Ä–æ—Å—Ç–æ "–∑–∞–≤–∏—Å", –æ–∂–∏–¥–∞—è –±–∞–∑—É.
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏.**¬†–í–∞–º –Ω–µ –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å¬†`db.close()`. –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è¬†`async with`¬†–≤–Ω—É—Ç—Ä–∏¬†`get_db`¬†–∏ –º–µ—Ö–∞–Ω–∏–∑–º¬†`Depends`¬†–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç, —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–µ—Ä–Ω–µ—Ç—Å—è –≤ –ø—É–ª, –¥–∞–∂–µ –µ—Å–ª–∏ –≤ –∫–æ–¥–µ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç –æ—à–∏–±–∫–∞.
- **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å (Testability).**¬†–ö–∞–∫ –∏ –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ, –≤—ã –ª–µ–≥–∫–æ –º–æ–∂–µ—Ç–µ –ø–æ–¥–º–µ–Ω–∏—Ç—å¬†`get_db`¬†–≤ —Ç–µ—Å—Ç–∞—Ö, –ø–æ–¥—Å—É–Ω—É–≤ —Ç–µ—Å—Ç–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏, –Ω–µ –º–µ–Ω—è—è –∫–æ–¥ —Ä–æ—É—Ç–µ—Ä–æ–≤.

---
#### üîπ Send email

```bash
# pip
pip install jinja2 aiosmtplib
# poetry
poetry add jinja2 aiosmtplib
```
==–≥–¥–µ:==
- `jinja2` - –ø–∞–∫–µ—Ç –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤
- `aiosmtplib`- –ø–∞–∫–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º

---
#### üîπ STRUCTURA PROJECT

–≠—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω, —á–∞—Å—Ç–æ –Ω–∞–∑—ã–≤–∞–µ–º—ã–π ==**"Feature-based structure"**== ‚Äî –≤—Å—ë, —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –æ–¥–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç—å—é, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ–¥–Ω–æ–π –ø–∞–ø–∫–µ
```bash
fastapi-project
‚îú‚îÄ‚îÄ alembic/
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router.py # –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã (—Ä–æ—É—Ç—ã)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas.py  # Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py  # ORM –º–æ–¥–µ–ª–∏ (SQLAlchemy –∏ —Ç.–ø.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dependencies.py # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ FastAPI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py  # local configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants.py # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –º–æ–¥—É–ª—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ service.py # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.py # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ aws
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.py  # client model for external service communication
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.py
‚îÇ   ‚îî‚îÄ‚îÄ posts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dependencies.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ service.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py  # global configs
‚îÇ   ‚îú‚îÄ‚îÄ models.py  # global models
‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py  # global exceptions
‚îÇ   ‚îú‚îÄ‚îÄ pagination.py  # global module e.g. pagination
‚îÇ   ‚îú‚îÄ‚îÄ database.py  # db connection related stuff
‚îÇ   ‚îî‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îú‚îÄ‚îÄ aws
‚îÇ   ‚îî‚îÄ‚îÄ posts
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ requirements
‚îÇ   ‚îú‚îÄ‚îÄ base.txt
‚îÇ   ‚îú‚îÄ‚îÄ dev.txt
‚îÇ   ‚îî‚îÄ‚îÄ prod.txt
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ logging.ini
‚îî‚îÄ‚îÄ alembic.ini
```

---
#### üîπ Lifespan
`Lifespan`¬†–≤ FastAPI (–∏ –ª–µ–∂–∞—â–µ–º –≤ –µ–≥–æ –æ—Å–Ω–æ–≤–µ Starlette) ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è–º–∏ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–¥ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ (`startup`) –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ (—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î, –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π) –∏ –ø—Ä–∏ –µ–≥–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ (`shutdown`) –¥–ª—è –∏—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ (–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏). –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–æ –∏ –∑–∞–≤–µ—Ä—à–∞–ª–æ —Ä–∞–±–æ—Ç—É, –æ—Å–≤–æ–±–æ–∂–¥–∞—è —Ä–µ—Å—É—Ä—Å—ã, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.¬†

–ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ

- –≠—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä (—á–∞—Å—Ç–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º¬†`async with lifespan:`) –∏–ª–∏ –Ω–∞–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (`@app.on_event("startup")`,¬†`on_shutdown`), –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏—è ASGI-—Å–µ—Ä–≤–µ—Ä–∞.
- –ö–æ–¥ –¥–æ¬†`yield`¬†–≤¬†`lifespan`¬†–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –∞ –∫–æ–¥ –ø–æ—Å–ª–µ¬†`yield`¬†‚Äî –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã.¬†

–î–ª—è —á–µ–≥–æ –Ω—É–∂–µ–Ω

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:**¬†–°–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª–æ–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö (SQLAlchemy, Redis), –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤ –∑–∞–¥–∞—á.
2. **–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤:**¬†–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á, –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
3. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ–Ω–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏:**¬†–ó–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤ –∑–∞–¥–∞—á (APScheduler), –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –≤¬†[—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–µ](https://habr.com/ru/companies/amvera/articles/859990/).
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**¬†–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∞–º–∏ –∏ –µ–≥–æ –æ—á–∏—Å—Ç–∫—É –ø–æ—Å–ª–µ, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.¬†

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—Å¬†`lifespan`)
```python
from fastapi import FastAPI

app = FastAPI()

@app.on_event("startup")
async def startup_event():
    print("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î
    # await database.connect()

@app.on_event("shutdown")
async def shutdown_event():
    print("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É...")
    # –û—á–∏—Å—Ç–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î
    # await database.disconnect()

@app.get("/")
async def root():
    return {"message": "Hello World"}
```

---
```
lsof -ti:8000 | xargs kill -9
```