#php #laravel #database 

==В файле `AppServiceProvider` создаем колбек для прослушивания все запросов к бд==
```php
public function boot()
{
    DB::listen(function ($query) {
        // TODO: принести пользу
    });
}

// в переменой query есть такие данные:
$query->sql; // выполненная sql-строка
$query->bindings; // параметры, переданные в запрос (то, что подменяет '?' в sql-строке)
$query->time; // время выполнения запроса

```

> узнать где выполнился запрос можно через функцию `debug_backtrace()`, в которой нам нужны данные по ключам `file` и `line`, но функция `debug_backtrace()` вызываеться много раз и часто из vendor, который нам не интересен, поэтому отфильтровываем вызовы из вендора

```php
DB::listen(function ($query) {
    $stackTrace = collect(debug_backtrace())->filter(function ($trace) {
        return !str_contains($trace['file'], 'vendor/');
    });
    
    dd($stackTrace);
});
```

==Данные по все запросам можно писать в логи, и их анализировать==
```php
public function boot()
{
    DB::listen(function ($query) {
        $location = collect(debug_backtrace())->filter(function ($trace) {
            return !str_contains($trace['file'], 'vendor/');
        })->first(); // берем первый элемент не из каталога вендора
        $bindings = implode(", ", $query->bindings); // форматируем привязку как строку
        Log::info("
               ------------
               Sql: $query->sql
               Bindings: $bindings
               Time: $query->time
               File: ${location['file']}
               Line: ${location['line']}
               ------------
        ");
    });
}
```
---
