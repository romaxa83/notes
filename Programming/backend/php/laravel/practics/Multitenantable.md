#php #laravel 

> ==Мультитенантность== (она же Мультиарендность, она же Multi-Tenancy) распространенное явление в веб-проектах — когда вы предоставляете доступ к записям только тем пользователям, кто их создал. Другими словами, каждый управляет своими собственными данными и не видит чужие.

> Представьте себе сайт по управлению Книгами и каждый пользователь может видеть только свои загруженные книги. Каждая книга привязана к стране происхождения из модели Country и эта модель должна быть доступна каждому, без мультитенантности

==в миграцию для книг добавляем такое поле==
```php
Schema::table('books', function (Blueprint $table) {
    $table->unsignedInteger('created_by_user_id');
    $table->foreign('created_by_user_id')->references('id')->on('users');
});
```

==в модель добавляем==
```php
protected $fillable = [
    'title',
    'country_id',
    'created_at',
    'updated_at',
    'created_by_user_id',
];
```

 ==создаем трейт `app/Traits/Multitenantable.php` с таким содержанием и добавляем его е тем моделя которые должны быть мультитенантными==
```php
namespace App\Traits;

use Illuminate\Database\Eloquent\Builder;

trait Multitenantable 
{
    protected static function bootMultitenantable()
    {
    	// see-1
        if (auth()->check()) {
            static::creating(function ($model) {
                $model->created_by_user_id = auth()->id();
            });
        }

        // see-3
        if (auth()->user()->role_id != 1) {
            // see-2
        	static::addGlobalScope('created_by_user_id', function (Builder $builder) {
            	$builder->where('created_by_user_id', auth()->id());
        	});
        }
    }
}
```

⚠️ Обратите внимание на имя метода `bootMultitenantable()` — соглашение об именах `bootXYZ()` означает, что Laravel автоматически запустит этот метод при использовании `Trait’а`. Можно назвать это «конструктором» `Trait’а`.

==see-1==
 Если пользователь залогинен, мы добавляем его идентификатор в поле `created_by_user_id`, какая бы ни была модель. мы нигде здесь не упоминаем `Book` или какую-либо другую модель. Таким образом, мы можем добавить этот `Trait` к любым моделям, которые захотим.

==see-2==
Фильтрация данных по пользователю, чтобы пользователь видил только свои записи для этого добавляем глобальный Scope для всех запросов к этой модели в этом трейте фильтр будет работать каждый раз, когда кто-либо получает список книг,  где бы он ни находился в проекте

==see-3==
добавляем проверку на роль, чтоб фильтр не работал, к примеру для админа который должен видеть все записи

---


